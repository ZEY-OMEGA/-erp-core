
import requests
import json
from typing import Dict, Any, Optional
from urllib.parse import urljoin
import jwt
from datetime import datetime, timedelta


class APIIntegrationBridge:
    """
    Ø§Ù„Ø¬Ø³Ø± Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
    ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Oracle, SAP, DPP, BravoAdvantage, UAEPASS
    """

    def __init__(self):
        self.adapters = {
            "oracle": self.oracle_adapter,
            "sap": self.sap_adapter,
            "dpp": self.dpp_adapter,
            "bravo": self.bravo_adapter,
            "uaepass": self.uaepass_adapter
        }
        self.active_connections = {}
        print("ðŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ API Integration Bridge Ø¨Ù†Ø¬Ø§Ø­")

    def connect(self, system_type: str, config: Dict[str, Any]) -> bool:
        """
        Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
        """
        if system_type not in self.adapters:
            print(f"âŒ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: {system_type}")
            return False

        try:
            adapter = self.adapters[system_type]
            connection = adapter("connect", {}, config)
            if connection.get("success"):
                self.active_connections[system_type] = {
                    "config": config,
                    "last_connected": datetime.now().isoformat()
                }
                print(f"âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…: {system_type.upper()}")
                return True
            else:
                print(f"âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…: {system_type} | Ø§Ù„Ø³Ø¨Ø¨: {connection.get('error')}")
                return False
        except Exception as e:
            print(f"ðŸ”´ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
            return False

    def execute(self, system_type: str, action: str, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø¬Ø³Ø±
        """
        if system_type not in self.active_connections:
            return {"success": False, "error": f"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ù…Ø¹ {system_type}"}

        try:
            adapter = self.adapters[system_type]
            result = adapter(action, data, self.active_connections[system_type]["config"])
            return result
        except Exception as e:
            return {"success": False, "error": f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°: {str(e)}"}

    # --- Ø§Ù„Ù…Ø­ÙˆÙ„Ø§Øª (Adapters) Ù„ÙƒÙ„ Ù†Ø¸Ø§Ù… ---

    def oracle_adapter(self, action: str,  Dict[str, Any], config: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ù…Ø­ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Oracle Cloud ERP
        """
        base_url = config.get("base_url")
        headers = {"Authorization": f"Bearer {config.get('token')}", "Content-Type": "application/json"}

        endpoints = {
            "create_project": "/projects",
            "update_inventory": "/inventory",
            "get_financials": "/financials"
        }

        try:
            if action == "connect":
                # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                response = requests.get(urljoin(base_url, "/health"), headers=headers)
                return {"success": response.status_code == 200}

            endpoint = endpoints.get(action)
            if not endpoint:
                return {"success": False, "error": "Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}

            url = urljoin(base_url, endpoint)
            response = requests.post(url, json=data, headers=headers)
            return response.json() if response.ok else {"success": False, "error": response.text}
        except Exception as e:
            return {"success": False, "error": str(e)}

    def sap_adapter(self, action: str,  Dict[str, Any], config: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ù…Ø­ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ SAP S/4HANA
        """
        base_url = config.get("base_url")
        auth = (config.get("username"), config.get("password"))

        try:
            if action == "connect":
                response = requests.get(urljoin(base_url, "/Ping"), auth=auth)
                return {"success": response.status_code == 200}

            # ÙÙŠ SAPØŒ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… RFC Ø£Ùˆ OData
            if action == "migrate_data":
                # Ù…Ø«Ø§Ù„: ØªØ±Ø­ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…
                payload = {
                    "SalesOrder": data.get("order_id"),
                    "SoldToParty": data.get("customer_id"),
                    "Item": [{"Material": item["sku"], "Quantity": item["qty"]} for item in data.get("items", [])]
                }
                url = urljoin(base_url, "/sap/opu/odata/sap/API_SALES_ORDER_SRV/A_SalesOrder")
                response = requests.post(url, json=payload, auth=auth)
                return {"success": response.ok, "data": response.json() if response.ok else response.text}
            else:
                return {"success": False, "error": "Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ SAP"}
        except Exception as e:
            return {"success": False, "error": str(e)}

    def dpp_adapter(self, action: str,  Dict[str, Any], config: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ù…Ø­ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù…Ù†ØµØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø§ØªØ­Ø§Ø¯ÙŠØ© (DPP)
        """
        base_url = config.get("base_url", "https://dpp.gov.ae/api/v1")
        client_id = config.get("client_id")
        client_secret = config.get("client_secret")

        def get_token():
            token_url = f"{base_url}/oauth/token"
            payload = {
                'grant_type': 'client_credentials',
                'client_id': client_id,
                'client_secret': client_secret
            }
            response = requests.post(token_url, data=payload)
            return response.json().get("access_token") if response.ok else None

        try:
            if action == "connect":
                token = get_token()
                if token:
                    return {"success": True, "token": token[:10] + "..."}
                else:
                    return {"success": False, "error": "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² DPP"}

            token = get_token()
            if not token:
                return {"success": False, "error": "Ø±Ù…Ø² DPP ØºÙŠØ± ØµØ§Ù„Ø­"}

            headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

            if action == "submit_tender_response":
                url = f"{base_url}/procurement/responses"
                payload = {
                    "rfqNumber": data.get("rfq_number"),
                    "vendorId": "ZeyOmega_ERP",
                    "solutionDetails": data.get("solution"),
                    "submissionDate": datetime.now().isoformat(),
                    "icvCertification": "Platinum"
                }
                response = requests.post(url, json=payload, headers=headers)
                return {"success": response.ok, "response": response.json()}
            else:
                return {"success": False, "error": "Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ DPP"}
        except Exception as e:
            return {"success": False, "error": str(e)}

    def bravo_adapter(self, action: str, data: Dict[str, Any], config: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ù…Ø­ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ BravoAdvantage
        """
        base_url = config.get("base_url", "https://api.bravoadvantage.com/v1")
        api_key = config.get("api_key")

        headers = {"X-API-Key": api_key, "Content-Type": "application/json"}

        try:
            if action == "connect":
                response = requests.get(f"{base_url}/ping", headers=headers)
                return {"success": response.status_code == 200}

            if action == "stop_supplier_contract":
                supplier_id = data.get("supplier_id")
                reason = data.get("reason", "Performance issues")
                url = f"{base_url}/suppliers/{supplier_id}/contract"
                payload = {"status": "suspended", "reason": reason}
                response = requests.patch(url, json=payload, headers=headers)
                return {"success": response.ok, "data": response.json()}
            elif action == "find_cheaper_alternative":
                category = data.get("category")
                budget = data.get("budget")
                url = f"{base_url}/suppliers/search?category={category}&max_price={budget}"
                response = requests.get(url, headers=headers)
                return {"success": response.ok, "alternatives": response.json()}
            else:
                return {"success": False, "error": "Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ BravoAdvantage"}
        except Exception as e:
            return {"success": False, "error": str(e)}

    def uaepass_adapter(self, action: str,  Dict[str, Any], config: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ù…Ø­ÙˆÙ„ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ UAEPASS Ù„Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        """
        base_url = config.get("base_url", "https://prod-auth.sso.gov.ae")
        client_id = config.get("client_id")
        redirect_uri = config.get("redirect_uri")

        try:
            if action == "connect":
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø®Ø¯Ù…Ø©
                response = requests.get(f"{base_url}/.well-known/openid-configuration")
                return {"success": response.ok}

            if action == "authenticate_user":
                # Ù‡Ø°Ù‡ Ø®Ø·ÙˆØ© ØªØªÙ… Ø¹Ø§Ø¯Ø© Ø¹Ø¨Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ØŒ Ù‡Ù†Ø§ Ù†Ù…Ø«Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                user_emirates_id = data.get("emirates_id")
                # ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± OAuth2
                return {
                    "success": True,
                    "user": {
                        "emirates_id": user_emirates_id,
                        "name": "Ahmed Al Mansoori",
                        "role": "Procurement Manager",
                        "organization": "Aldar Properties"
                    }
                }
            else:
                return {"success": False, "error": "Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ UAEPASS"}
        except Exception as e:
            return {"success": False, "error": str(e)}

    # --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    
    def log_transaction(self, system: str, action: str, success: bool, details: str = ""):
        """
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
        """
        timestamp = datetime.now().isoformat()
        log_entry = {
            "timestamp": timestamp,
            "system": system,
            "action": action,
            "success": success,
            "details": details
        }
        # ÙÙŠ Ø¨ÙŠØ¦Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ù…Ø±ÙƒØ²ÙŠ
        print(f"ðŸ“ LOG: [{timestamp}] {action} on {system} â†’ {'Success' if success else 'Failed'} | {details}")

    def get_connection_status(self) -> Dict[str, Any]:
        """
        Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        """
        return {
            "active_connections": list(self.active_connections.keys()),
            "count": len(self.active_connections),
            "last_updated": datetime.now().isoformat()
        }