
import speech_recognition as sr
from core.ats_core_pro import ATSCorePro
from core.ethics_guard import EthicsAndComplianceGuard
from core.decision_trigger import DecisionTriggerProtocol
import pyttsx3
import threading
import time


class MultilingualVoiceInterface:
    """
    ÙˆØ§Ø¬Ù‡Ø© ØµÙˆØªÙŠØ© Ø°ÙƒÙŠØ© ØªØ¯Ø¹Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    ÙˆØªÙØ¹Ø§Ù„Ø¬Ù‡Ø§ Ø¹Ø¨Ø± UCCP Processor ÙˆØªÙ†ÙØ°Ù‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ATSCorePro
    """

    def __init__(self):
        self.recognizer = sr.Recognizer()
        self.microphone = sr.Microphone()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©
        self.ats = ATSCorePro()
        self.ethics = EthicsAndComplianceGuard()
        self.trigger = DecisionTriggerProtocol(self.ats)
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª
        self.engine = pyttsx3.init()
        self.engine.setProperty('rate', 180)
        self.engine.setProperty('volume', 1.0)

        # Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØª Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
        voices = self.engine.getProperty('voices')
        self.arabic_voice = None
        self.english_voice = None
        for voice in voices:
            if "ar" in str(voice.languages) or "Arabic" in voice.name:
                self.arabic_voice = voice
            if "en" in str(voice.languages) or "English" in voice.name:
                self.english_voice = voice

        self.is_listening = False
        print("ğŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ Multilingual Voice Interface Ø¨Ù†Ø¬Ø§Ø­")
        print("   ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©")

    def speak(self, text: str, lang: str = "ar"):
        """
        Ø¥Ø®Ø±Ø§Ø¬ ØµÙˆØªÙŠ Ø¨Ù„ØºØ© Ù…Ø·Ø§Ø¨Ù‚Ø©
        """
        def run():
            if lang == "ar" and self.arabic_voice:
                self.engine.setProperty('voice', self.arabic_voice.id)
            elif self.english_voice:
                self.engine.setProperty('voice', self.english_voice.id)
            self.engine.say(text)
            self.engine.runAndWait()

        thread = threading.Thread(target=run)
        thread.start()

    def detect_language(self, text: str) -> str:
        """
        ÙƒØ´Ù Ø§Ù„Ù„ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        """
        arabic_chars = set("Ø£Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙ‰ÙŠ")
        return "ar" if any(c in text for c in arabic_chars) else "en"

    def listen_once(self) -> tuple:
        """
        Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ
        """
        with self.microphone as source:
            print("ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...")
            self.recognizer.adjust_for_ambient_noise(source, duration=1)
            try:
                audio = self.recognizer.listen(source, timeout=5, phrase_time_limit=10)
                # Ø£ÙˆÙ„Ù‹Ø§: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                try:
                    text = self.recognizer.recognize_google(audio, language="ar-SA")
                    print(f"ğŸ”Š ØªÙ… Ø§Ù„ØªØ¹Ø±Ù (Ø¹Ø±Ø¨ÙŠ): {text}")
                    return text, "ar"
                except sr.UnknownValueError:
                    # Ø«Ø§Ù†ÙŠÙ‹Ø§: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                    try:
                        text = self.recognizer.recognize_google(audio, language="en-US")
                        print(f"ğŸ”Š ØªÙ… Ø§Ù„ØªØ¹Ø±Ù (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): {text}")
                        return text, "en"
                    except sr.UnknownValueError:
                        error_msg = "Ù„Ù… Ø£ÙÙ‡Ù… Ù…Ø§ Ù‚Ù„ØªÙ‡. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒØ±Ø§Ø± Ø°Ù„ÙƒØŸ"
                        print(f"âŒ {error_msg}")
                        self.speak(error_msg, "ar")
                        return None, None
            except sr.WaitTimeoutError:
                timeout_msg = "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹. Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª."
                print(f"â° {timeout_msg}")
                self.speak(timeout_msg, "ar")
                return None, None
            except Exception as e:
                print(f"ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹: {e}")
                self.speak("Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹.", "ar")
                return None, None

    def parse_command(self, raw_input: str) -> dict:
        """
        ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ø¥Ù„Ù‰ ÙØ¹Ù„ ÙˆÙ‡Ø¯Ù
        """
        raw_input = raw_input.strip().lower()
        command = {"raw": raw_input, "action": None, "target": None}

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙØ¹Ù„
        if any(word in raw_input for word in ["Ø£ÙˆÙ‚Ù", "Ø§ÙŠÙ‚Ø§Ù", "ØªÙˆÙ‚Ù"]):
            command["action"] = "stop"
        elif any(word in raw_input for word in ["Ø§Ø±ÙØ¹", "Ø²ÙŠØ§Ø¯Ø©", "Ø±ÙØ¹"]):
            command["action"] = "increase"
        elif any(word in raw_input for word in ["Ø£Ù†Ø´Ø¦", "Ø§ÙØªØ­", "Ø§Ø¨Ø¯Ø£"]):
            command["action"] = "create"
        elif any(word in raw_input for word in ["ÙˆØ²Ø¹", "Ø£Ø±Ø³Ù„", "Ø­ÙˆÙ‘Ù„"]):
            command["action"] = "distribute"
        elif any(word in raw_input for word in ["Ø­Ø¯Ù‘Ø«", "Ø¹Ø¯Ù‘Ù„", "ØºÙŠØ±"]):
            command["action"] = "update"
        elif any(word in raw_input for word in ["Ø£Ø¨Ù„Øº", "Ø£Ø¸Ù‡Ø±", "Ø¹Ø±Ø¶"]):
            command["action"] = "report"
        elif any(word in raw_input for word in ["Ø§Ø¨Ø­Ø«", "Ø¬Ø¯", "Ø§Ø³ØªÙƒØ´Ù"]):
            command["action"] = "find"

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø¯Ù
        if any(word in raw_input for word in ["Ù…Ø¨ÙŠØ¹Ø§Øª", "Ø¨ÙŠØ¹", "sales"]):
            command["target"] = "sales"
        elif any(word in raw_input for word in ["Ù…Ø®Ø²ÙˆÙ†", "Ù…Ø³ØªÙˆØ¯Ø¹", "inventory"]):
            command["target"] = "inventory"
        elif any(word in raw_input for word in ["Ù…Ø­Ø§Ø³Ø¨Ø©", "Ù…ÙŠØ²Ø§Ù†ÙŠØ©", "finance"]):
            command["target"] = "finance"
        elif any(word in raw_input for word in ["Ù…ÙˆØ¸ÙÙŠÙ†", "Ø­Ø¶ÙˆØ±", "hr"]):
            command["target"] = "hr"
        elif any(word in raw_input for word in ["Ù…Ø´Ø§Ø±ÙŠØ¹", "planning"]):
            command["target"] = "projects"
        elif any(word in raw_input for word in ["ØªØ£Ù…ÙŠÙ†", "Ù…Ø·Ø§Ù„Ø¨Ø§Øª", "insurance"]):
            command["target"] = "insurance"

        return command

    def validate_and_process(self, command: dict):
        """
        Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨
        """
        result = self.ethics.validate_and_respond(command)
        if result["allowed"]:
            goal_text = f"{command['action']}_{command['target']}"
            self.ats.g = goal_text
            print(f"âœ… ØªÙ… ÙÙ‡Ù… Ø§Ù„Ø·Ù„Ø¨: '{goal_text}'")
            print("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø±...")
        else:
            print(f"âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨: {result['explanation']}")

    def start_continuous_listening(self):
        """
        Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø±
        """
        self.is_listening = True
        intro = "Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£ÙˆØ§Ù…Ø±. Ù‚Ù„ 'ØªÙˆÙ‚Ù' ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…."
        print(intro)
        self.speak(intro, "ar")

        while self.is_listening:
            command_text, lang = self.listen_once()
            if command_text:
                lower_cmd = command_text.lower()
                if any(word in lower_cmd for word in ["ØªÙˆÙ‚Ù", "stop listening", "Ø§ÙƒÙ Ø¹Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹"]):
                    self.is_listening = False
                    farewell = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹. Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ."
                    print(farewell)
                    self.speak(farewell, "ar")
                    break
                else:
                    command = self.parse_command(command_text)
                    self.validate_and_process(command)
            time.sleep(1)

    def start(self):
        """
        Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙˆØªÙŠØ©
        """
        welcome = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Zey Omega ERP Ø§Ù„ØµÙˆØªÙŠ. Ù‚Ù„ 'Ø§Ø³ØªÙ…Ø¹' Ù„Ù„Ø¨Ø¯Ø¡."
        print(welcome)
        self.speak(welcome, "ar")

        while True:
            command_text, lang = self.listen_once()
            if command_text:
                lower_cmd = command_text.lower()
                if any(word in lower_cmd for word in ["Ø§Ø³ØªÙ…Ø¹", "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹", "listen", "start"]):
                    # ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø± ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„
                    trigger_thread = threading.Thread(target=self.trigger.start_monitoring, daemon=True)
                    trigger_thread.start()
                    
                    self.start_continuous_listening()
                    self.speak("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† Ø£Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ Ù‚Ù„ 'Ø§Ø³ØªÙ…Ø¹'.", "ar")
                elif any(word in lower_cmd for word in ["ÙˆØ¯Ø§Ø¹Ù‹Ø§", "goodbye", "exit", "Ø§Ù†Ù‡Ù"]):
                    self.speak("ÙˆØ¯Ø§Ø¹Ù‹Ø§! Ø­ØªÙ‰ Ø§Ù„Ù„Ù‚Ø§Ø¡.", "ar")
                    break
                else:
                    self.speak("Ù‚Ù„ 'Ø§Ø³ØªÙ…Ø¹' Ù„Ù„Ø¨Ø¯Ø¡ØŒ Ø£Ùˆ 'ÙˆØ¯Ø§Ø¹Ù‹Ø§' Ù„Ù„Ø¥ØºÙ„Ø§Ù‚.", "ar")


# ===========================
# Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ©
# ===========================

def test_voice_interface():
    """
    Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙˆØªÙŠØ©
    """
    print("ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Multilingual Voice Interface...")
    voice = MultilingualVoiceInterface()
    voice.start()


if __name__ == "__main__":
    test_voice_interface()
```